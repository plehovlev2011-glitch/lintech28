<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤—ã–π –î–Ω–µ–≤–Ω–∏–∫ - –®–∫–æ–ª–∞ 28</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- –õ–æ–≥–∏–Ω –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        async function checkAuth() {
            try {
                const response = await fetch('/api/data?type=info', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—à–±–æ—Ä–¥
                    loadDashboard();
                } else {
                    // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω
                    loadLogin();
                }
            } catch (error) {
                // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω
                loadLogin();
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞
        async function loadLogin() {
            const response = await fetch('/login.html');
            const html = await response.text();
            document.getElementById('app').innerHTML = html;
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
            setTimeout(() => {
                const form = document.getElementById('loginForm');
                if (form) {
                    form.addEventListener('submit', handleLogin);
                }
            }, 100);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞
        async function handleLogin(e) {
            e.preventDefault();
            
            const form = e.target;
            const login = form.querySelector('#username').value;
            const password = form.querySelector('#password').value;
            const errorDiv = document.getElementById('loginError');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –í—Ö–æ–¥...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ login, password }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                    showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    setTimeout(() => loadDashboard(), 1000);
                } else {
                    // –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞
                    errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    errorDiv.style.display = 'block';
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                errorDiv.style.display = 'block';
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞—à–±–æ—Ä–¥
        async function loadDashboard() {
            const response = await fetch('/dashboard.html');
            const html = await response.text();
            document.getElementById('app').innerHTML = html;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞—à–±–æ—Ä–¥
            setTimeout(() => {
                initDashboard();
            }, 100);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞
        async function initDashboard() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadUserData();
            setupEventListeners();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
            showLoading();
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ü–µ–Ω–∫–∏
                const marksResponse = await fetch('/api/data?type=marks', {
                    credentials: 'include'
                });
                const marks = await marksResponse.json();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                displayMarks(marks);
                
                // –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                hideLoading();
                
            } catch (error) {
                console.error('Error loading data:', error);
                hideLoading();
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showToast(message, type = 'info') {
            // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ—Å—Ç–∞
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        checkAuth();
    </script>
</body>
</html>
